machine:
  environment:
    image: circleci/build-image
    tar: trusty-beta-$CIRCLE_SHA1.tar.gz
    tagged_tar: trusty-beta-$CIRCLE_TAG.tar.gz

  services:
    - docker

dependencies:
  override:
    - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS

test:
  override:
    - docker pull $image || true:
        timeout: 3600

    - docker build -t $image .:
        timeout: 3600

    - docker push $image:
        timeout: 3600

    - ./docker-export $image > $tar:
        timeout: 3600

deployment:
  release:
    tag: /v.*/
    commands:
      - mv $tar $tagged_tar
      - aws s3 cp $tagged_tar s3://circle-downloads/ --acl public-read

  aws-s3:
    branch: /trusty-beta/
    commands:
      - aws s3 cp $tar s3://circle-downloads/ --acl public-read

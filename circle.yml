version: 2.0
jobs:
  build:
    executorType: machine
    containerInfo:
      - image: docker:1.9
    environment:
      IMAGE_REPO: "circleci/build-image"
      BUILD_TARGET: ubuntu-14.04-XXL
    workDir: ~/image-builder
    steps:
      - type: checkout
      - shell: git clone git@github.com:kimh/docker-cache-shim.git && cd docker-cache-shim && sudo ./install.sh
      # Fail early if no build targets
      - shell: make --dry-run ${BUILD_TARGET:-notarget}
      - type: shell
        name: build image
        noOutputTimeout: 7200
        command: |
          if $(no_cache); then
            make no_cache=true build-$BUILD_TARGET
          else
            make build-$BUILD_TARGET
          fi

      - shell: make test-$BUILD_TARGET
      - shell: make dump-version-$BUILD_TARGET
